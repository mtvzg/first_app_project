# Инструкция по разработке на Django

---

### Создание проекта:

В Django существует 2 основных понятия:
* ```менеджер``` - зависящая от приложений сущность для управления приложениями и их взаимодействием
* ```приложение``` - обособленная часть кода, выполняющая определенную задачу или цель

Для создания менеджера используется команда:
```bash
django-admin startproject manage_app .
```

Для запуска сервера используется команда:
```bash
python manage.py runserver
```

Для создания приложения используется команда:
```bash
python manage.py startapp first_app
```

---


### Работа с приложением:

Django реализует паттерн MVC (Model View Controller):
* ```Model [Модель]``` - сущность для работы с данными (получение из БД, их преобразование, запись, удаление, редактирование)
* ```View [Представление]``` - сущность для отображения данных без логики (отображение на странице)
* ```Controller [Контроллер]``` - сущность - посредник между данными и отображением. Не должен содержать логики

Для создания страницы следует выполнить следующие шаги:
1. Создать функцию в ```views.py``` (в приложении), которая вернет представление страницы
```python
from datetime import date

from django.shortcuts import render, HttpResponse


def current_date(request):
    return HttpResponse(f'<h1>{date.today()}</h1>')

```

2. В файле ```urls.py``` добавить маршрут для страницы (может не быть в приложении - нужно создать в нашем приложении)
```python
from django.urls import path
from first_app import views

urlpatterns = [
    path('', views.current_date, name='current_date')
]
```

3. В менеджере приложений, в файле ```urls.py``` необходимо импортировать ```include```, после чего добавить созданные 
маршруты, как показано на примере ниже:
```python
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('first_app.urls'))
]
```
---

### Виды ответов

* ```JsonResponse``` - возвращает ответ в виде JSON
* ```HttpResponse``` - возвращает ответ в виде HTML или HTTP-кода

---

### Создание шаблонов

```Шаблон``` - это HTML код страницы с возможностью использования Python кода в виде директив (if, for, block).
Допускает расширение.

```Статика (статичный контент)``` - неизменяемый во времени дополнительный контент страницы: (CSS, JavaScript, картинки, видео и т.п.)

Шаблоны бывают: 
* ```Базовыми``` - неизменяемый каркас страницы с областями для вставки динамической области (block)
* ```Расширяемыми``` - динамическая составляющая конкретной страницы

Для создания шаблона необходимо: 
1. В папке с приложением создать папки ```templates``` и ```static```
2. В папке ```static``` создать папки категорий (CSS, JS, image и т.д.). При необходимости добавить смысловые папки для разделения по категориям.
3. Создаем статичный контент в папках
4. В папке шаблонов создаем дополнительные папки при необходимости
5. Создаем базовый шаблон
6. Создаем расширяемые шаблоны

---

### Добавление приложений в менеджере приложений

В менеджере приложений в файле ```settings.py``` необходимо добавить в начало приложение в виде строки 
````'<название приложения>.apps.<название класса из файла apps.py папки приложения>'````
в список ```INSTALLED_APPS```.

Пример:
```python
# Application definition

INSTALLED_APPS = [
    'first_app.apps.FirstAppConfig',
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]
```

---

### Директива шаблонизатора

```Директива``` - команда шаблонизатора, для выполнения определенной логики

Директивы можно писать в ```{% <директива> %}``` или ```{{ <директива> }}```

Доступные директивы: 
* ```{% load static %}``` - загрузка статичного контента
* ```{% static '<путь к файлу статики в папке static>' %}``` - путь к статическому контенту
* Оператор ветвления. Обязательно должен заканчиваться директивой ```{% endif %}```:
```
    {% if title %}
        если правда
    {% else %}
        если не правда (необязательный блок)
    {% endif %}
  ```
* ```{% url '<название маршрута>' %}``` - создание ссылки на именованный маршрут. Указание имени несуществующего маршрута приведет к ошибке. ОБ ЭТОМ СТОИТ ПОМНИТЬ!!!
* ```{% block content %}{% endblock %}``` в базовой шаблоне это динамическая (изменяемая) часть. В наследуемом - контент изменяемой области.
* ```{% extends "<путь к базовому шаблону>" %}``` - наследование (расширение) базового шаблона.
* Цикл (перебор):
```
{% for item in <имя итерируемого объекта> %}
        <код отрисовки одного элемента>
    {% endfor %}
```

---

### Отрисовка шаблона

Для отрисовки шаблона на странице необходимо в функции - представлении (второй аргумент функции ```path```, хранятся в папке приложения ```views.py```):
```python
from django.shortcuts import render

def <название страницы>_page(request):
    return render(request, '<путь до шаблона в папке templates>', {'<словарь с контекстом>'})
```

```Контекст``` - словарь, где ключ это имя переменной, а значение - это значение этой переменной. Содержит в себе переменные, которые доступны в шаблоне. Контекст не является обязательной переменной функции ```render```.

---

### Подключение к БД

В файле ```settings.py``` нашего менеджера приложений в переменной ```DATABASES``` нужно заменить код на 
```python
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'my_local_database', # название базы данных
        'USER': 'postgres', # имя пользователя БД
        'PASSWORD': 'root', # пароль
        'HOST': '127.0.0.1', # хост(можно указать "localhost" если приложение на том же сервере, что и БД
        'PORT': 5432 #
```

И создать через СУБД базу данных с именем ```NAME```

Для запуска миграций необходимо выполнить команду в терминале:

```python manage.py migrate```

Миграции нужно выполнять при внесении изменений в модель.

### Доступ к админке 

Для доступа к админке нужно перейти по адресу ```http://localhost:8000/admin```

Для создания пользователя необходимо выполнить команду 
```python
python manage.py createsuperuser
```

И следовать указаниям.

Для изменения пароля пользователя используется команда
```python
python manage.py changepassword <имя пользователя>
```

---

### Работа с моделями

Модели хранятся в приложении в файле ```models.py```

Все модели должны быть унаследованы от ```django.db.models.Model```. Свойства класса модели в последствии
станут колонками в таблице

```python
#Класс модели
from django.db import models
from django.utils import timezone
from django.contrib.auth.models import User


class Post(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    date_create = models.DateTimeField(default=timezone.now)
    author = models.ForeignKey(User, on_delete=models.CASCADE)

    def __str__(self):
        return self.title

```

Модель - это классовое представление конкретной таблицы в Python, где свойства класса это кнопка в таблице, 
а конкретный экземпляр - конкретная запись в БД.

После изменений моделей обязательно нужно выполнить команду создания миграции:
```bash
python manage.py makemigrations
```

Они отображаются в папке приложения с именем ```migrations``` 

Для применения миграции используется команда 
```bash
python manage.py migrate
```

Для отображения модели в админке, необходимо в файле ```admin.py``` в нашем приложении эту модель 
зарегистрировать.

```python
from django.contrib import admin

from first_app.models import Post


admin.site.register(Post)
```

---

### Создание формы для входа на сайт(работа с формами)

Формы в Django - это способ взаимодействия с пользователем, позволяющий ему отправлять данные на сервер. 
Формы используются для сбора информации от пользователя, например, при регистрации, входе на сайт, отправке комментариев и т.д.

Для создания формы в Django мы можем использовать классы форм из модуля ```django.forms```. 
Класс формы представляет собой Python-класс, который определяет поля формы и их поведение. 
Мы можем определить форму как самостоятельно, так и использовать модельные формы для работы с данными моделей.

Пример создания простой формы:
```python
from django import forms

class MyForm(forms.Form):
    name = forms.CharField(label='Your Name', max_length=100)
    email = forms.EmailField(label='Your Email')
```

Метод ```forms.CharField``` в Django используется для определения поля формы, которое представляет собой строку текста.
Этот метод создает объект поля для ввода текста в форме. 
```python
CharField(max_length=None, min_length=None, strip=True, empty_value='', **kwargs)
```

Основные параметры метода ```forms.CharField```:

1. ```max_length```: Максимальная длина текстового поля (по умолчанию None, что означает отсутствие ограничения).
2. ```min_length```: Минимальная длина текстового поля (по умолчанию None, что означает отсутствие ограничения).
3. ```strip```: Флаг, указывающий, нужно ли удалять пробелы по краям значения (по умолчанию ```True```).
4. ```empty_value```: Значение по умолчанию для пустого поля (по умолчанию '')

Дополнительные аргументы метода ```forms.CharField``` в Django:

1. ```required```: указывает, является ли поле обязательным для заполнения. 
По умолчанию значение ```required=True```, что означает, что поле должно быть заполнено перед отправкой формы. 
Если установить ```required=False```, то поле станет необязательным.
2. ```label```: позволяет задать пользовательскую метку для поля. 
Это текст, который будет отображаться рядом с полем в форме и помогать пользователям понять, что от них требуется. 
Например, ```label='Your Name'```.
3. ```help_text```: позволяет добавить вспомогательный текст или подсказку к полю формы.
Он обычно используется для предоставления дополнительной информации о том, как заполнить поле. 
Например, ```help_text='Enter your full name'```.
4. ```widget```: позволяет настроить виджет (визуальное представление) поля формы. 
Например, можно использовать ```forms.EmailInput()``` для того, чтобы поле ввода электронной почты имело виджет для ввода адреса электронной почты.

---

Далее настраиваем отображение формы в шаблоне:

```html
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Submit</button>
</form>
```

Где: ```{% csrf_token %}``` - используется для включения защиты от подделки межсайтовых запросов (CSRF) в форму. 
CSRF - это атака, при которой злоумышленник отправляет запрос от имени авторизованного пользователя без его согласия.
При использовании директивы ```{% csrf_token %}```, Django вставляет скрытое поле в форму, содержащее уникальный токен CSRF.
При отправке формы на сервер, этот токен проверяется, чтобы убедиться, что запрос был отправлен с правильной страницы и не был подделан.
Таким образом, использование ```{% csrf_token %}``` помогает обеспечить безопасность вашего веб-приложения, защищая его от атак CSRF.

Директива ```{{ form.as_p }}``` в шаблоне Django используется для автоматической генерации HTML кода формы на основе определенной формы в представлении. 
Когда вы используете ```{{ form.as_p }}```, Django автоматически создает HTML элементы формы, такие как поля ввода, метки и кнопки, в виде абзацев <p>.

Далее настраиваем обработку формы во ```views.py```: 
```python
from django.shortcuts import render
from .forms import MyForm

def my_view(request):
    if request.method == 'POST':
        form = MyForm(request.POST)
        if form.is_valid():
            name = form.cleaned_data['name']
            email = form.cleaned_data['email']
            # Делаем что-то с данными
    else:
        form = MyForm()
    
    return render(request, 'my_template.html', {'form': form})
```

